version: '3.6'

services:

  ui:
    image: registry.gitlab.com/skn0tt/ente/ui:${UI_TAG}
    restart: on-failure
    labels:
      - "traefik.enable=true"
      - "traefik.frontend.rule=PathPrefixStrip: /"
    environment:
      SENTRY_DSN_UI: ${sentry.ui}
      ROTATION_PERIOD: ${config.rotation_period.ui}
      ALLOW_INSECURE: ${debug.allow_http}
      CONFIG_VARS: SENTRY_DSN_UI,ROTATION_PERIOD,ALLOW_INSECURE
    networks:
      - ente_bridge

  api:
    image: registry.gitlab.com/skn0tt/ente/api:${API_TAG}
    restart: on-failure
    depends_on:
      - redis
      - railmail
      - signer
    labels:
      - "traefik.enable=true"
      - "traefik.frontend.rule=PathPrefixStrip: /api/"
    environment:
      NODE_ENV: ${debug.environment}
      BASE_URL: ${config.baseUrl}
      RAILMAIL_HOST: http://railmail
      SIGNER_BASEURL: http://signer:3000
      ENABLE_CRON_JOBS: "true"
      CRON_WEEKLY_SUMMARY: "0 16 * * 5"
      SENTRY_DSN_API: ${sentry.api}
      MYSQL_HOST: ${mysql.host}
      MYSQL_PORT: ${mysql.port}
      MYSQL_DATABASE: ${mysql.database}
      MYSQL_USERNAME: ${mysql.username}
      MYSQL_PASSWORD: ${mysql.password}
      REDIS_HOST: redis
      REDIS_PORT: 6379
    networks:
      - ente_bridge

  railmail:
    image: skn0tt/railmail:v0.3.0
    restart: on-failure
    environment:
      SMTP_HOST: ${smtp.host}
      SMTP_PORT: ${smtp.port}
      SMTP_USERNAME: ${smtp.username}
      SMTP_PASSWORD: ${smtp.password}
      SMTP_SENDER: ${smtp.sender}
    networks:
      - ente_bridge

  signer:
    image: skn0tt/signer:v0.5.0
    depends_on:
      - redis
    restart: on-failure
    environment:
      REDIS_HOSTNAME: redis
      TOKEN_EXPIRY: ${config.rotation_period.keys}
      ROTATION_INTERVAL: ${config.rotation_period.keys}
      ROTATE_ON_STARTUP: "true"
      ASYMMETRIC_SIGNING: "true"
    networks:
      - ente_bridge

  redis:
    image: redis:4.0.10
    networks:
      - ente_bridge

  traefik:
    image: traefik
    command:
      - "--api"
      - "--docker"
      - "--docker.exposedbydefault=false"
    depends_on:
      - api
      - ui
    ports:
      - "${config.port}:80"
      - "${debug.traefik_dashboard_port}:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - ente_bridge

networks:
  ente_bridge:
    driver: bridge
    driver_opts:
        com.docker.network.bridge.name: ente_bridge
